name: ðŸš€ DevFactory Homepage Deploy
run-name: ðŸš€ Deploying to Production by @${{ github.actor }}

on:
  #  push:
  #    branches:
  #      - main
  #    paths:
  #      - 'platform/**'
  #      - '.github/workflows/devfactory-homepage.yml'
  workflow_dispatch:

# ê°™ì€ ë¸Œëžœì¹˜ ë™ì‹œ ì‹¤í–‰ ì‹œ ì´ì „ ìž¡ ì·¨ì†Œ(ê²½ìŸ ë°°í¬ ë°©ì§€)
concurrency:
  group: DevFactory-homepage-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy-prod:
    if: github.ref_name == 'main'
    name: ðŸš€ Deploy DF-platform (Production)
    runs-on: oracle
    environment: platform
    defaults:
      run:
        working-directory: ./platform
    steps:
      - uses: actions/checkout@v4

      - name: Write .env (prod)
        run: |
          cat > .env <<'EOF'
          APP_HOST=${{ vars.APP_HOST }}
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          ACCESS_LOGGING_IP_SALT=${{ secrets.ACCESS_LOGGING_IP_SALT }}
          EOF

      - name: Build & up (prod)
        run: |
          set -euxo pipefail
          docker compose -p df-platform-main config -q
          docker compose -p df-platform-main down --remove-orphans
          docker compose -p df-platform-main up -d --build --remove-orphans
          docker image prune -f --filter "label=org.pseudolab.project=devfactory-platform"
