services:
  # Development Overrides with Traefik Support
  frontend:
    build:
      context: ./frontend
      target: build-stage
    image: devfactory-frontend:dev
    command: npm run dev -- --host 0.0.0.0
    volumes:
      - ./frontend:/app
      - /app/node_modules
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik
      - traefik.http.routers.df-platform-web.rule=Host(`${APP_HOST}`)
      - traefik.http.routers.df-platform-web.entrypoints=websecure
      - traefik.http.routers.df-platform-web.tls=true
      - traefik.http.routers.df-platform-web.tls.certresolver=le
      - traefik.http.services.df-platform-web.loadbalancer.server.port=5173
      # HTTP → HTTPS redirect (re-adding to ensure full functionality)
      - traefik.http.routers.df-platform-web-http.rule=Host(`${APP_HOST}`)
      - traefik.http.routers.df-platform-web-http.entrypoints=web
      - traefik.http.routers.df-platform-web-http.middlewares=redirect-to-https@file
      - traefik.http.routers.df-platform-web-http.service=df-platform-web

  server:
    command: npm run dev
    volumes:
      - ./server:/app
      - /app/node_modules
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik
      - traefik.http.routers.df-platform-api.rule=Host(`${APP_HOST}`) && PathPrefix(`/api`)
      - traefik.http.routers.df-platform-api.entrypoints=websecure
      - traefik.http.routers.df-platform-api.tls=true
      - traefik.http.routers.df-platform-api.tls.certresolver=le
      - traefik.http.services.df-platform-api.loadbalancer.server.port=3000
      # HTTP → HTTPS redirect
      - traefik.http.routers.df-platform-api-http.rule=Host(`${APP_HOST}`) && PathPrefix(`/api`)
      - traefik.http.routers.df-platform-api-http.entrypoints=web
      - traefik.http.routers.df-platform-api-http.middlewares=redirect-to-https@file
      - traefik.http.routers.df-platform-api-http.service=df-platform-api
