services:
  # Frontend static server (Nginx)
  frontend:
    build:
      context: ./frontend
      labels:
        - "org.pseudolab.project=devfactory-platform"
    container_name: devfactory-frontend
    restart: unless-stopped
    networks:
      - traefik
      - internal
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik
      # --- Traefik Router (frontend) ---
      - traefik.http.routers.df-platform-web.rule=Host(`${APP_HOST}`)
      - traefik.http.routers.df-platform-web.entrypoints=websecure
      - traefik.http.routers.df-platform-web.tls=true
      - traefik.http.routers.df-platform-web.tls.certresolver=le
      - traefik.http.services.df-platform-web.loadbalancer.server.port=80
      # HTTP → HTTPS redirect
      - traefik.http.routers.df-platform-web-http.rule=Host(`${APP_HOST}`)
      - traefik.http.routers.df-platform-web-http.entrypoints=web
      - traefik.http.routers.df-platform-web-http.middlewares=redirect-to-https@file
      - traefik.http.routers.df-platform-web-http.service=df-platform-web

  # Backend API server
  server:
    build:
      context: ./server
      labels:
        - "org.pseudolab.project=devfactory-platform"
    container_name: devfactory-api
    restart: unless-stopped
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - PORT=3000
    networks:
      - traefik
      - internal
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik
      # --- Traefik Router (backend) ---
      - traefik.http.routers.df-platform-api.rule=Host(`${APP_HOST}`) && PathPrefix(`/api`)
      - traefik.http.routers.df-platform-api.entrypoints=websecure
      - traefik.http.routers.df-platform-api.tls=true
      - traefik.http.routers.df-platform-api.tls.certresolver=le
      - traefik.http.services.df-platform-api.loadbalancer.server.port=3000
      # HTTP → HTTPS redirect
      - traefik.http.routers.df-platform-api-http.rule=Host(`${APP_HOST}`) && PathPrefix(`/api`)
      - traefik.http.routers.df-platform-api-http.entrypoints=web
      - traefik.http.routers.df-platform-api-http.middlewares=redirect-to-https@file
      - traefik.http.routers.df-platform-api-http.service=df-platform-api

networks:
  traefik:
    external: true
  internal:
    driver: bridge
